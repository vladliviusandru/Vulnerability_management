# Generated by Django 3.0 on 2021-02-21 18:04


from django.db import migrations
import os
import csv
from datetime import datetime

IMPORT_DIR = os.path.join(os.path.dirname(os.path.abspath(__file__)), "import")

def import_function(apps, schema_editor):
    Assets = apps.get_model("main", "Assets")
    SoftwareLicences = apps.get_model("main", "SoftwareLicences")
    TrafficVolumeHistory = apps.get_model("main", "TrafficVolumeHistory")

    with open(os.path.join(IMPORT_DIR, "import_assets_1.csv")) as assets_csv_file:
        reader = csv.reader(assets_csv_file)
        header = next(reader)
        assets = []

        for row in reader:
            asset = Assets(name=row[0],
                           type=row[1],
                           category=row[2],
                           os=row[3],
                           manufacturer=row[4],
                           dnshostname=row[5],
                           ip=row[6]
                           )
            assets.append(asset)

        Assets.objects.bulk_create(assets)

    with open(os.path.join(IMPORT_DIR, "import_sw_licences_1.csv")) as sw_licences_csv_file:
        reader = csv.reader(sw_licences_csv_file)
        header = next(reader)
        softwarelicences = []

        for row in reader:
            softwarelicence = SoftwareLicences(device_id=Assets.objects.get(asset_id=int(row[0])),
                                               sw_name=row[1],
                                               publisher=row[2],
                                               category=row[3],
                                               license_type=row[4],
                                               version=row[5],
                                               eol=str(datetime.strptime(row[6], "%Y-%m-%d").date())
                                               )
            softwarelicences.append(softwarelicence)

        SoftwareLicences.objects.bulk_create(softwarelicences)

    with open(os.path.join(IMPORT_DIR, "import_traffic_1.csv")) as traffic_csv_file:
        reader = csv.reader(traffic_csv_file)
        header = next(reader)
        trafficvolumehistory = []

        for row in reader:
            trafficvolume = TrafficVolumeHistory(device_id=Assets.objects.get(asset_id=int(row[0])),
                                                 volume=row[1],
                                                 timestamp=str(datetime.strptime(row[2] + ":" + row[3], "%d-%m-%Y:%H:%M"))
                                                )
            trafficvolumehistory.append(trafficvolume)

        TrafficVolumeHistory.objects.bulk_create(trafficvolumehistory)


class Migration(migrations.Migration):

    dependencies = [
        ('main', '0005_auto_20210221_2002'),
    ]

    operations = [migrations.RunPython(import_function),
    ]
